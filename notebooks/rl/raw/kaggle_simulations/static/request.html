<!DOCTYPE html>
<html>
  <head>
    <title>Kaggle Simulations - Request Builder</title>
    <style type="text/css">
      body {
        font-family: monospace;
        font-size: 16px;
        margin: 24px;
      }
      fieldset {
        margin-bottom: 24px;
      }
      label {
        display: block;
        font-weight: bold;
        margin-top: 8px;
      }
      textarea {
        min-height: 64px;
        width: 100%;
      }
      #agents div {
        margin-top: 24px;
      }
      #execute {
        display: block;
        font-size: 24px;
        margin: 32px auto;
      }
      #response div {
        border: 1px solid darkgray;
        display: none;
        padding: 8px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <h1>Kaggle Simulations Demo</h1>

    <fieldset>
      <legend>Environment</legend>
      <label>Name:</label>
      <select id="environment">
        <option value="tictactoe" selected>Tic Tac Toe</option>
        <option value="connectx">Connect X</option>
      </select>
      <label>Configuration:</label>
      <textarea id="configuration"></textarea>
      <label>State:</label>
      <textarea id="state"></textarea>
    </fieldset>

    <fieldset>
      <legend>Agents</legend>
      <button id="add_agent">Add Agent</button>
      <div id="agents"></div>
    </fieldset>

    <fieldset>
      <legend>Options</legend>
      <label>Action:</label>
      <select id="action">
        <option value="evaluate" selected>Evaluate</option>
        <option value="run">Run</option>
        <option value="step">Step</option>
      </select>
      <label># of Episodes:</label>
      <input type="number" value="0" id="episodes" />
      <label>Output:</label>
      <select id="output">
        <option value="json" selected>JSON</option>
        <option value="ascii">ASCII</option>
      </select>
      <label>Url:</label>
      <input type="text" value="" id="url" />
    </fieldset>

    <fieldset id="request">
      <legend>Request Body (readonly)</legend>
      <textarea readonly></textarea>
    </fieldset>

    <button id="execute">Execute Request</button>

    <fieldset id="response">
      <legend>Response (readonly)</legend>
      <textarea readonly></textarea>
      <div></div>
    </fieldset>

    <script type="text/javascript">
      // Helpers.
      const updateSize = el => {
        el.style.height = "";
        el.style.height = el.scrollHeight + "px";
      };
      const autosize = textarea => {
        textarea.addEventListener(
          "input",
          updateSize.bind(null, textarea),
          false
        );
        updateSize(textarea);
      };
      const parse = str => {
        try {
          return JSON.parse(str);
        } catch {}
      };
      const $ = document.querySelector.bind(document);
      const $c = (tagname, parent, innerHTML, events) => {
        const el = document.createElement(tagname);
        if (events)
          for (let n in events) el.addEventListener(n, events[n], false);
        if (innerHTML) el.innerHTML = innerHTML;
        if (parent) parent.appendChild(el);
        if (tagname == "textarea") autosize(el);
        return el;
      };

      // Elements.
      const $environment = $("#environment");
      const $configuration = $("#configuration");
      const $state = $("#state");
      const $agents = $("#agents");
      const $action = $("#action");
      const $episodes = $("#episodes");
      const $output = $("#output");
      const $url = $("#url");
      const $execute = $("#execute");
      const $request = $("#request textarea");
      const $response = $("#response textarea");
      const $responseAscii = $("#response div");

      // Request Builder.
      const buildRequest = () => {
        const $agents = Array.from(
          document.querySelectorAll("#agents textarea")
        );
        const body = {
          environment: $environment.value,
          configuration: parse($configuration.value),
          state: parse($state.value),
          agents: $agents.map(a => a.value),
          action: $action.value,
          episodes: parseInt($episodes.value),
          output: $output.value,
        };
        for (const name in body) {
          if (!body[name]) {
            delete body[name];
          }
        }
        $request.value = JSON.stringify(body, null, 2);
        updateSize($request);
        return body;
      };

      const sendRequest = async () => {
        const body = buildRequest();
        const request = {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body, null, 2),
        };
        const response = await fetch($url.value, request);
        const json = await response.json();
        if (body.output === "ascii") {
          $responseAscii.style.display = "block";
          $response.style.display = "none";
          $responseAscii.innerHTML = json.ascii;
        } else {
          $responseAscii.style.display = "none";
          $response.style.display = "block";
          $response.value = JSON.stringify(json, null, 2);
        }
        updateSize($response);
      };

      const addAgent = (value = "random") => {
        const $agent = $c("div", $agents);
        $c("textarea", $agent, value, { change: buildRequest });
        $c("button", $agent, "Remove", {
          click: () => {
            agents.removeChild($agent);
            buildRequest();
          },
        });
        buildRequest();
      };

      // Event Listeners.
      $execute.addEventListener("click", sendRequest, false);

      $("#add_agent").addEventListener("click", () => addAgent(), false);

      [
        $environment,
        $configuration,
        $state,
        $action,
        $episodes,
        $output,
      ].forEach(el => {
        el.addEventListener("input", buildRequest, false);
      });

      [$configuration, $state, $request, $response].forEach(el => autosize(el));

      // Setup.
      addAgent("random");
      addAgent(`from random import choice
      
def random_agent(obs):
    return choice(list(filter(lambda m: m[1] == 0, enumerate(obs.board))))[0]`);
      buildRequest();
      $url.value = document.location.origin + "/cli";
    </script>
  </body>
</html>
